<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Invoice Generator - Unit Tests</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }

    .test-container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    h1 {
      color: #333;
      margin-bottom: 20px;
    }

    .test-result {
      padding: 12px;
      margin: 10px 0;
      border-radius: 4px;
      border-left: 4px solid;
    }

    .test-result.pass {
      background: #e8f5e9;
      border-color: #4caf50;
      color: #2e7d32;
    }

    .test-result.fail {
      background: #ffebee;
      border-color: #f44336;
      color: #c62828;
    }

    .test-summary {
      margin-top: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 4px;
      font-weight: 600;
    }

    .test-summary.all-pass {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .test-summary.has-fail {
      background: #ffebee;
      color: #c62828;
    }

    .test-name {
      font-weight: 600;
      margin-bottom: 5px;
    }

    .test-details {
      font-size: 0.9em;
      opacity: 0.8;
    }
  </style>
</head>

<body>
  <div class="test-container">
    <h1>ðŸ“‹ Invoice Generator - Unit Tests</h1>
    <h2>Test Suite: Required Form Fields</h2>
    <div id="testResults"></div>
    <div id="testSummary" class="test-summary"></div>

    <h2 style="margin-top: 40px;">Property-Based Tests</h2>
    <div id="pbtResults"></div>
    <div id="pbtSummary" class="test-summary"></div>
  </div>

  <!-- Load the invoice generator HTML in an iframe to test it -->
  <iframe id="invoiceFrame" src="invoice-generator.html" style="display: none;"></iframe>

  <!-- fast-check library for property-based testing -->
  <script src="https://cdn.jsdelivr.net/npm/fast-check@3.15.0/lib/bundle.js"></script>

  <script>
    // Unit Test Framework
    const testResults = [];

    function assert(condition, testName, details = '') {
      const result = {
        name: testName,
        passed: condition,
        details: details
      };
      testResults.push(result);
      displayTestResult(result);
    }

    function displayTestResult(result) {
      const resultsDiv = document.getElementById('testResults');
      const resultDiv = document.createElement('div');
      resultDiv.className = `test-result ${result.passed ? 'pass' : 'fail'}`;

      const status = result.passed ? 'âœ“ PASS' : 'âœ— FAIL';
      resultDiv.innerHTML = `
        <div class="test-name">${status}: ${result.name}</div>
        ${result.details ? `<div class="test-details">${result.details}</div>` : ''}
      `;

      resultsDiv.appendChild(resultDiv);
    }

    function displaySummary() {
      const summaryDiv = document.getElementById('testSummary');
      const totalTests = testResults.length;
      const passedTests = testResults.filter(r => r.passed).length;
      const failedTests = totalTests - passedTests;

      const allPassed = failedTests === 0;
      summaryDiv.className = `test-summary ${allPassed ? 'all-pass' : 'has-fail'}`;
      summaryDiv.innerHTML = `
        <div>Test Summary: ${passedTests}/${totalTests} tests passed</div>
        ${failedTests > 0 ? `<div>${failedTests} test(s) failed</div>` : '<div>All tests passed! âœ“</div>'}
      `;
    }

    // Wait for iframe to load, then run tests
    window.addEventListener('load', function () {
      setTimeout(runTests, 500); // Give iframe time to fully load
    });

    function runTests() {
      const iframe = document.getElementById('invoiceFrame');
      const doc = iframe.contentDocument || iframe.contentWindow.document;

      console.log('Running unit tests for required form fields...');

      // Test 1.1: Verify all required form fields exist
      // Requirements 1.1: Business name, client name, invoice number, invoice date, due date,
      // service description, hours/quantity, rate, tax rate, additional notes, currency selector

      // Test: Business Name field exists
      const businessNameField = doc.getElementById('businessName');
      assert(
        businessNameField !== null,
        'Business Name field exists',
        'Field ID: businessName'
      );

      // Test: Client Name field exists
      const clientNameField = doc.getElementById('clientName');
      assert(
        clientNameField !== null,
        'Client Name field exists',
        'Field ID: clientName'
      );

      // Test: Invoice Number field exists
      const invoiceNumberField = doc.getElementById('invoiceNumber');
      assert(
        invoiceNumberField !== null,
        'Invoice Number field exists',
        'Field ID: invoiceNumber'
      );

      // Test: Invoice Date field exists
      const invoiceDateField = doc.getElementById('invoiceDate');
      assert(
        invoiceDateField !== null,
        'Invoice Date field exists',
        'Field ID: invoiceDate'
      );

      // Test: Due Date field exists
      const dueDateField = doc.getElementById('dueDate');
      assert(
        dueDateField !== null,
        'Due Date field exists',
        'Field ID: dueDate'
      );

      // Test: Service Description field exists
      const serviceDescriptionField = doc.getElementById('serviceDescription');
      assert(
        serviceDescriptionField !== null,
        'Service Description field exists',
        'Field ID: serviceDescription'
      );

      // Test: Hours/Quantity field exists
      const quantityField = doc.getElementById('quantity');
      assert(
        quantityField !== null,
        'Hours/Quantity field exists',
        'Field ID: quantity'
      );

      // Test: Rate field exists
      const rateField = doc.getElementById('rate');
      assert(
        rateField !== null,
        'Rate field exists',
        'Field ID: rate'
      );

      // Test: Tax Rate field exists
      const taxRateField = doc.getElementById('taxRate');
      assert(
        taxRateField !== null,
        'Tax Rate field exists',
        'Field ID: taxRate'
      );

      // Test: Additional Notes field exists
      const additionalNotesField = doc.getElementById('additionalNotes');
      assert(
        additionalNotesField !== null,
        'Additional Notes field exists',
        'Field ID: additionalNotes'
      );

      // Test: Currency selector field exists
      const currencyField = doc.getElementById('currency');
      assert(
        currencyField !== null,
        'Currency selector field exists',
        'Field ID: currency'
      );

      // Additional validation tests for field types and attributes

      // Test: Business Name is a text input
      assert(
        businessNameField && businessNameField.type === 'text',
        'Business Name is a text input',
        `Type: ${businessNameField ? businessNameField.type : 'N/A'}`
      );

      // Test: Currency is a select element
      assert(
        currencyField && currencyField.tagName === 'SELECT',
        'Currency is a select element',
        `Tag: ${currencyField ? currencyField.tagName : 'N/A'}`
      );

      // Test: Quantity is a number input
      assert(
        quantityField && quantityField.type === 'number',
        'Quantity is a number input',
        `Type: ${quantityField ? quantityField.type : 'N/A'}`
      );

      // Test: Rate is a number input
      assert(
        rateField && rateField.type === 'number',
        'Rate is a number input',
        `Type: ${rateField ? rateField.type : 'N/A'}`
      );

      // Test: Tax Rate is a number input
      assert(
        taxRateField && taxRateField.type === 'number',
        'Tax Rate is a number input',
        `Type: ${taxRateField ? taxRateField.type : 'N/A'}`
      );

      // Test: Invoice Date is a date input
      assert(
        invoiceDateField && invoiceDateField.type === 'date',
        'Invoice Date is a date input',
        `Type: ${invoiceDateField ? invoiceDateField.type : 'N/A'}`
      );

      // Test: Due Date is a date input
      assert(
        dueDateField && dueDateField.type === 'date',
        'Due Date is a date input',
        `Type: ${dueDateField ? dueDateField.type : 'N/A'}`
      );

      // Test: Service Description is a textarea
      assert(
        serviceDescriptionField && serviceDescriptionField.tagName === 'TEXTAREA',
        'Service Description is a textarea',
        `Tag: ${serviceDescriptionField ? serviceDescriptionField.tagName : 'N/A'}`
      );

      // Test: Additional Notes is a textarea
      assert(
        additionalNotesField && additionalNotesField.tagName === 'TEXTAREA',
        'Additional Notes is a textarea',
        `Tag: ${additionalNotesField ? additionalNotesField.tagName : 'N/A'}`
      );

      // Test: Currency selector has all required options (â‚¹, $, â‚¬, Â£)
      if (currencyField) {
        const options = Array.from(currencyField.options).map(opt => opt.value);
        const hasAllCurrencies = ['â‚¹', '$', 'â‚¬', 'Â£'].every(currency => options.includes(currency));
        assert(
          hasAllCurrencies,
          'Currency selector has all required options (â‚¹, $, â‚¬, Â£)',
          `Available options: ${options.join(', ')}`
        );
      }

      // Display summary
      displaySummary();

      console.log('Tests completed:', testResults);

      // Run property-based tests after unit tests
      runPropertyBasedTests();
    }

    // ===== PROPERTY-BASED TESTS =====

    const pbtResults = [];

    function displayPBTResult(result) {
      const resultsDiv = document.getElementById('pbtResults');
      const resultDiv = document.createElement('div');
      resultDiv.className = `test-result ${result.passed ? 'pass' : 'fail'}`;

      const status = result.passed ? 'âœ“ PASS' : 'âœ— FAIL';
      let detailsHtml = '';
      if (result.details) {
        detailsHtml = `<div class="test-details">${result.details}</div>`;
      }
      if (result.counterexample) {
        detailsHtml += `<div class="test-details"><strong>Counterexample:</strong> ${result.counterexample}</div>`;
      }

      resultDiv.innerHTML = `
        <div class="test-name">${status}: ${result.name}</div>
        ${detailsHtml}
      `;

      resultsDiv.appendChild(resultDiv);
    }

    function displayPBTSummary() {
      const summaryDiv = document.getElementById('pbtSummary');
      const totalTests = pbtResults.length;
      const passedTests = pbtResults.filter(r => r.passed).length;
      const failedTests = totalTests - passedTests;

      const allPassed = failedTests === 0;
      summaryDiv.className = `test-summary ${allPassed ? 'all-pass' : 'has-fail'}`;
      summaryDiv.innerHTML = `
        <div>Property Test Summary: ${passedTests}/${totalTests} properties verified</div>
        ${failedTests > 0 ? `<div>${failedTests} property test(s) failed</div>` : '<div>All property tests passed! âœ“</div>'}
      `;
    }

    function runPropertyBasedTests() {
      console.log('Running property-based tests...');

      // Feature: invoice-generator, Property 1: Invoice number format consistency
      // **Validates: Requirements 1.2**
      // Property: For any generated invoice number, it should match the format INV-YYYYMMDD-XXX 
      // where YYYYMMDD is a valid date and XXX is a three-digit number.

      const iframe = document.getElementById('invoiceFrame');
      const iframeWindow = iframe.contentWindow;

      // Test the generateInvoiceNumber function
      try {
        const result = fc.assert(
          fc.property(
            fc.integer({ min: 1, max: 999 }), // Sequence number
            (seqNum) => {
              // Set up the sequence number in localStorage
              iframeWindow.localStorage.setItem('lastInvoiceSeq', String(seqNum - 1));

              // Generate invoice number
              const invoiceNumber = iframeWindow.generateInvoiceNumber();

              // Validate format: INV-YYYYMMDD-XXX
              const pattern = /^INV-\d{8}-\d{3}$/;
              if (!pattern.test(invoiceNumber)) {
                return false;
              }

              // Extract parts
              const parts = invoiceNumber.split('-');
              const dateStr = parts[1]; // YYYYMMDD
              const seqStr = parts[2];  // XXX

              // Validate date part is a valid date
              const year = parseInt(dateStr.substring(0, 4));
              const month = parseInt(dateStr.substring(4, 6));
              const day = parseInt(dateStr.substring(6, 8));

              // Check if date is valid
              const date = new Date(year, month - 1, day);
              const isValidDate = date.getFullYear() === year &&
                date.getMonth() === month - 1 &&
                date.getDate() === day;

              if (!isValidDate) {
                return false;
              }

              // Validate sequence is exactly 3 digits
              if (seqStr.length !== 3) {
                return false;
              }

              // Validate sequence number matches expected
              const actualSeq = parseInt(seqStr);
              if (actualSeq !== seqNum) {
                return false;
              }

              return true;
            }
          ),
          { numRuns: 100 } // Run 100 iterations as specified in design doc
        );

        pbtResults.push({
          name: 'Property 1: Invoice number format consistency',
          passed: true,
          details: 'Verified with 100 random test cases. Format INV-YYYYMMDD-XXX is consistent.'
        });
        displayPBTResult(pbtResults[pbtResults.length - 1]);

      } catch (error) {
        pbtResults.push({
          name: 'Property 1: Invoice number format consistency',
          passed: false,
          details: 'Property test failed',
          counterexample: error.message || String(error)
        });
        displayPBTResult(pbtResults[pbtResults.length - 1]);
      }

      // Feature: invoice-generator, Property 2: Due date calculation
      // **Validates: Requirements 1.4**
      // Property: For any invoice date, the default due date should be exactly 7 days later.

      try {
        const result = fc.assert(
          fc.property(
            fc.date({ min: new Date('2000-01-01'), max: new Date('2099-12-31') }), // Random date
            (invoiceDate) => {
              // Calculate due date using the function from invoice generator
              const dueDate = iframeWindow.calculateDueDate(invoiceDate);

              // Calculate expected due date (7 days later)
              const expectedDueDate = new Date(invoiceDate);
              expectedDueDate.setDate(expectedDueDate.getDate() + 7);

              // Compare dates (year, month, day)
              const dueDateMatches =
                dueDate.getFullYear() === expectedDueDate.getFullYear() &&
                dueDate.getMonth() === expectedDueDate.getMonth() &&
                dueDate.getDate() === expectedDueDate.getDate();

              return dueDateMatches;
            }
          ),
          { numRuns: 100 } // Run 100 iterations as specified in design doc
        );

        pbtResults.push({
          name: 'Property 2: Due date calculation',
          passed: true,
          details: 'Verified with 100 random test cases. Due date is always exactly 7 days after invoice date.'
        });
        displayPBTResult(pbtResults[pbtResults.length - 1]);

      } catch (error) {
        pbtResults.push({
          name: 'Property 2: Due date calculation',
          passed: false,
          details: 'Property test failed',
          counterexample: error.message || String(error)
        });
        displayPBTResult(pbtResults[pbtResults.length - 1]);
      }

      // Display PBT summary
      displayPBTSummary();

      console.log('Property-based tests completed:', pbtResults);
    }
  </script>
</body>

</html>